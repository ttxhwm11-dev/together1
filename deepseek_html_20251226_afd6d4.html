<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>元气骑士简化版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #111;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: Arial, sans-serif;
            overflow: hidden;
            color: white;
        }
        
        #gameContainer {
            position: relative;
            width: 800px;
            height: 600px;
            background-color: #1a1a2e;
            border: 3px solid #4a4a8a;
            overflow: hidden;
        }
        
        #gameCanvas {
            background-color: #16213e;
        }
        
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            font-size: 18px;
            text-shadow: 1px 1px 2px black;
        }
        
        #health, #coins, #weapon, #room {
            margin-bottom: 8px;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        #gameOver, #gameStart {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }
        
        #gameStart {
            display: flex;
        }
        
        #gameOver {
            display: none;
        }
        
        h1 {
            color: #ffcc00;
            margin-bottom: 20px;
            font-size: 48px;
            text-shadow: 0 0 10px #ff9900;
        }
        
        h2 {
            color: #ff6666;
            margin-bottom: 20px;
        }
        
        button {
            background-color: #4a4a8a;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #6a6aaa;
        }
        
        #controls {
            margin-top: 30px;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 8px;
            max-width: 500px;
        }
        
        .control-item {
            margin: 8px 0;
        }
        
        .key {
            display: inline-block;
            background-color: #333;
            padding: 2px 8px;
            border-radius: 4px;
            margin: 0 5px;
            font-family: monospace;
        }
        
        #enemyCount {
            color: #ff6666;
        }
        
        #room {
            color: #66ccff;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div id="ui">
            <div id="health">生命值: <span id="healthValue">10</span></div>
            <div id="coins">金币: <span id="coinsValue">0</span></div>
            <div id="weapon">武器: <span id="weaponValue">手枪</span> (子弹: <span id="ammoValue">∞</span>)</div>
            <div id="room">房间: <span id="roomValue">1</span>/5 | 敌人: <span id="enemyCount">3</span></div>
        </div>
        
        <div id="gameStart">
            <h1>元气骑士简化版</h1>
            <p style="margin-bottom: 20px; max-width: 600px; text-align: center; font-size: 18px; line-height: 1.5;">
                你是一名勇敢的骑士，需要穿越5个房间，击败所有敌人，找到出口！
            </p>
            <div id="controls">
                <div class="control-item">移动: <span class="key">W</span><span class="key">A</span><span class="key">S</span><span class="key">D</span></div>
                <div class="control-item">射击: 鼠标左键</div>
                <div class="control-item">更换武器: <span class="key">Q</span> 或 鼠标滚轮</div>
                <div class="control-item">使用技能: <span class="key">空格键</span> (冷却: 5秒)</div>
                <div class="control-item">拾取物品: 靠近后按 <span class="key">E</span></div>
            </div>
            <button id="startButton">开始游戏</button>
        </div>
        
        <div id="gameOver">
            <h2>游戏结束</h2>
            <p id="gameResult">你击败了所有敌人!</p>
            <p id="finalStats">通关房间: <span id="finalRooms">0</span> | 击败敌人: <span id="finalEnemies">0</span> | 获得金币: <span id="finalCoins">0</span></p>
            <button id="restartButton">重新开始</button>
        </div>
    </div>

    <script>
        // 获取Canvas和上下文
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // 游戏状态
        let gameState = 'start'; // start, playing, gameOver
        let currentRoom = 1;
        let totalRooms = 5;
        let playerHealth = 10;
        let playerCoins = 0;
        let enemiesRemaining = 0;
        let enemiesDefeated = 0;
        
        // 玩家属性
        const player = {
            x: 400,
            y: 300,
            radius: 15,
            speed: 4,
            dx: 0,
            dy: 0,
            color: '#4a9eff',
            weapon: 0,
            weapons: [
                {name: '手枪', damage: 1, cooldown: 10, ammo: Infinity, color: '#cccccc'},
                {name: '冲锋枪', damage: 1, cooldown: 5, ammo: 30, color: '#66ccff'},
                {name: '霰弹枪', damage: 3, cooldown: 30, ammo: 20, color: '#ff9966'},
                {name: '激光枪', damage: 2, cooldown: 15, ammo: 15, color: '#ff66ff'}
            ],
            shootCooldown: 0,
            skillCooldown: 0,
            skillActive: false,
            skillDuration: 0,
            invincible: 0
        };
        
        // 子弹数组
        let bullets = [];
        
        // 敌人数组
        let enemies = [];
        
        // 物品数组
        let items = [];
        
        // 房间配置
        let room = {
            width: 800,
            height: 600,
            doors: []
        };
        
        // 按键状态
        const keys = {};
        
        // 鼠标状态
        let mouse = {
            x: 0,
            y: 0,
            clicked: false
        };
        
        // 初始化游戏
        function initGame() {
            player.x = 400;
            player.y = 300;
            playerHealth = 10;
            playerCoins = 0;
            currentRoom = 1;
            enemiesDefeated = 0;
            player.weapon = 0;
            
            bullets = [];
            enemies = [];
            items = [];
            
            generateRoom(currentRoom);
            updateUI();
        }
        
        // 生成房间
        function generateRoom(roomNum) {
            enemies = [];
            items = [];
            room.doors = [];
            
            // 根据房间号生成不同数量的敌人
            let enemyCount = 2 + roomNum;
            enemiesRemaining = enemyCount;
            
            // 生成敌人
            for (let i = 0; i < enemyCount; i++) {
                let enemyX, enemyY;
                let validPosition = false;
                
                // 确保敌人不会生成在玩家附近
                while (!validPosition) {
                    enemyX = Math.random() * (room.width - 100) + 50;
                    enemyY = Math.random() * (room.height - 100) + 50;
                    
                    // 检查与玩家的距离
                    const distToPlayer = Math.sqrt((enemyX - player.x) ** 2 + (enemyY - player.y) ** 2);
                    if (distToPlayer > 150) {
                        validPosition = true;
                    }
                }
                
                // 不同类型的敌人
                let enemyType = Math.floor(Math.random() * 3);
                if (roomNum >= 4) enemyType = Math.floor(Math.random() * 4);
                
                enemies.push({
                    x: enemyX,
                    y: enemyY,
                    radius: roomNum >= 4 ? 20 : 15,
                    speed: 1 + Math.random() * 0.5,
                    health: roomNum,
                    maxHealth: roomNum,
                    color: enemyType === 0 ? '#ff6666' : enemyType === 1 ? '#ff9966' : enemyType === 2 ? '#ff66cc' : '#66ffcc',
                    type: enemyType,
                    shootCooldown: 0,
                    targetX: player.x,
                    targetY: player.y
                });
            }
            
            // 生成门（出口）
            if (roomNum < totalRooms) {
                room.doors.push({
                    x: room.width - 50,
                    y: room.height / 2,
                    width: 40,
                    height: 80,
                    color: '#8a4a3a'
                });
            }
            
            // 有几率生成物品
            if (Math.random() > 0.5) {
                items.push({
                    x: Math.random() * (room.width - 100) + 50,
                    y: Math.random() * (room.height - 100) + 50,
                    type: Math.random() > 0.5 ? 'health' : 'coin',
                    value: 1
                });
            }
            
            // 更新UI
            document.getElementById('enemyCount').textContent = enemiesRemaining;
            document.getElementById('roomValue').textContent = currentRoom;
        }
        
        // 绘制游戏
        function drawGame() {
            // 清空画布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 绘制背景
            ctx.fillStyle = '#16213e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 绘制房间边界
            ctx.strokeStyle = '#4a4a8a';
            ctx.lineWidth = 5;
            ctx.strokeRect(2, 2, canvas.width - 4, canvas.height - 4);
            
            // 绘制门
            room.doors.forEach(door => {
                ctx.fillStyle = door.color;
                ctx.fillRect(door.x, door.y, door.width, door.height);
                ctx.fillStyle = '#ffcc00';
                ctx.font = '14px Arial';
                ctx.fillText('出口', door.x + 5, door.y + 50);
            });
            
            // 绘制物品
            items.forEach(item => {
                if (item.type === 'health') {
                    ctx.fillStyle = '#ff3333';
                    ctx.beginPath();
                    ctx.moveTo(item.x, item.y - 10);
                    ctx.lineTo(item.x - 8, item.y + 8);
                    ctx.lineTo(item.x, item.y + 5);
                    ctx.lineTo(item.x + 8, item.y + 8);
                    ctx.closePath();
                    ctx.fill();
                } else if (item.type === 'coin') {
                    ctx.fillStyle = '#ffcc00';
                    ctx.beginPath();
                    ctx.arc(item.x, item.y, 8, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#ff9900';
                    ctx.beginPath();
                    ctx.arc(item.x, item.y, 5, 0, Math.PI * 2);
                    ctx.fill();
                }
            });
            
            // 绘制敌人
            enemies.forEach(enemy => {
                // 敌人身体
                ctx.fillStyle = enemy.color;
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, enemy.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // 敌人眼睛
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.arc(enemy.x - enemy.radius/3, enemy.y - enemy.radius/3, enemy.radius/3, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(enemy.x + enemy.radius/3, enemy.y - enemy.radius/3, enemy.radius/3, 0, Math.PI * 2);
                ctx.fill();
                
                // 敌人瞳孔
                ctx.fillStyle = 'black';
                ctx.beginPath();
                ctx.arc(enemy.x - enemy.radius/3, enemy.y - enemy.radius/3, enemy.radius/6, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.arc(enemy.x + enemy.radius/3, enemy.y - enemy.radius/3, enemy.radius/6, 0, Math.PI * 2);
                ctx.fill();
                
                // 敌人生命值条
                const healthWidth = 30;
                const healthPercent = enemy.health / enemy.maxHealth;
                ctx.fillStyle = '#333';
                ctx.fillRect(enemy.x - healthWidth/2, enemy.y - enemy.radius - 10, healthWidth, 5);
                ctx.fillStyle = healthPercent > 0.5 ? '#66ff66' : healthPercent > 0.2 ? '#ffff66' : '#ff6666';
                ctx.fillRect(enemy.x - healthWidth/2, enemy.y - enemy.radius - 10, healthWidth * healthPercent, 5);
            });
            
            // 绘制子弹
            bullets.forEach(bullet => {
                ctx.fillStyle = bullet.color;
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.radius, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // 绘制玩家
            // 玩家身体
            ctx.fillStyle = player.skillActive ? '#ffff00' : player.color;
            ctx.beginPath();
            ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
            ctx.fill();
            
            // 玩家护盾效果
            if (player.invincible > 0) {
                ctx.strokeStyle = 'rgba(100, 200, 255, 0.7)';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(player.x, player.y, player.radius + 3, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // 玩家眼睛（看向鼠标方向）
            const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
            const eyeX = Math.cos(angle) * player.radius/2;
            const eyeY = Math.sin(angle) * player.radius/2;
            
            ctx.fillStyle = 'white';
            ctx.beginPath();
            ctx.arc(player.x + eyeX, player.y + eyeY, player.radius/2, 0, Math.PI * 2);
            ctx.fill();
            
            ctx.fillStyle = 'black';
            ctx.beginPath();
            ctx.arc(player.x + eyeX, player.y + eyeY, player.radius/4, 0, Math.PI * 2);
            ctx.fill();
            
            // 绘制武器指示器
            ctx.strokeStyle = player.weapons[player.weapon].color;
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(player.x, player.y);
            ctx.lineTo(player.x + Math.cos(angle) * 25, player.y + Math.sin(angle) * 25);
            ctx.stroke();
            
            // 绘制技能冷却
            if (player.skillCooldown > 0) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(10, canvas.height - 30, 100, 20);
                ctx.fillStyle = '#66ccff';
                const cooldownWidth = 100 * (1 - player.skillCooldown / 300);
                ctx.fillRect(10, canvas.height - 30, cooldownWidth, 20);
                ctx.fillStyle = 'white';
                ctx.font = '14px Arial';
                ctx.fillText('技能冷却', 15, canvas.height - 15);
            }
            
            // 绘制当前武器信息
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(canvas.width - 150, canvas.height - 30, 140, 20);
            ctx.fillStyle = 'white';
            ctx.font = '14px Arial';
            ctx.fillText(`武器: ${player.weapons[player.weapon].name}`, canvas.width - 145, canvas.height - 15);
        }
        
        // 更新游戏逻辑
        function updateGame() {
            // 更新玩家位置
            if (keys['w'] || keys['ArrowUp']) player.dy = -player.speed;
            if (keys['s'] || keys['ArrowDown']) player.dy = player.speed;
            if (keys['a'] || keys['ArrowLeft']) player.dx = -player.speed;
            if (keys['d'] || keys['ArrowRight']) player.dx = player.speed;
            
            // 如果没有按键，减速
            if (!(keys['w'] || keys['ArrowUp'] || keys['s'] || keys['ArrowDown'])) player.dy *= 0.8;
            if (!(keys['a'] || keys['ArrowLeft'] || keys['d'] || keys['ArrowRight'])) player.dx *= 0.8;
            
            // 更新玩家位置
            player.x += player.dx;
            player.y += player.dy;
            
            // 边界检测
            if (player.x - player.radius < 5) player.x = player.radius + 5;
            if (player.x + player.radius > room.width - 5) player.x = room.width - player.radius - 5;
            if (player.y - player.radius < 5) player.y = player.radius + 5;
            if (player.y + player.radius > room.height - 5) player.y = room.height - player.radius - 5;
            
            // 更新技能状态
            if (player.skillCooldown > 0) player.skillCooldown--;
            if (player.skillActive) {
                player.skillDuration--;
                if (player.skillDuration <= 0) {
                    player.skillActive = false;
                }
            }
            
            // 更新无敌时间
            if (player.invincible > 0) player.invincible--;
            
            // 射击冷却
            if (player.shootCooldown > 0) player.shootCooldown--;
            
            // 鼠标射击
            if (mouse.clicked && player.shootCooldown <= 0) {
                const currentWeapon = player.weapons[player.weapon];
                
                // 检查弹药
                if (currentWeapon.ammo > 0 || currentWeapon.ammo === Infinity) {
                    const angle = Math.atan2(mouse.y - player.y, mouse.x - player.x);
                    
                    if (currentWeapon.name === '霰弹枪') {
                        // 霰弹枪发射多颗子弹
                        for (let i = -2; i <= 2; i++) {
                            const spreadAngle = angle + (i * 0.2);
                            bullets.push({
                                x: player.x + Math.cos(angle) * 20,
                                y: player.y + Math.sin(angle) * 20,
                                dx: Math.cos(spreadAngle) * 8,
                                dy: Math.sin(spreadAngle) * 8,
                                radius: 4,
                                damage: currentWeapon.damage,
                                color: currentWeapon.color,
                                life: 60
                            });
                        }
                    } else {
                        // 普通枪发射一颗子弹
                        bullets.push({
                            x: player.x + Math.cos(angle) * 20,
                            y: player.y + Math.sin(angle) * 20,
                            dx: Math.cos(angle) * 8,
                            dy: Math.sin(angle) * 8,
                            radius: currentWeapon.name === '激光枪' ? 6 : 4,
                            damage: currentWeapon.damage,
                            color: currentWeapon.color,
                            life: currentWeapon.name === '激光枪' ? 30 : 60
                        });
                    }
                    
                    player.shootCooldown = currentWeapon.cooldown;
                    
                    // 减少弹药
                    if (currentWeapon.ammo !== Infinity) {
                        currentWeapon.ammo--;
                        updateUI();
                    }
                }
            }
            
            // 更新子弹
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                bullet.x += bullet.dx;
                bullet.y += bullet.dy;
                bullet.life--;
                
                // 边界检测
                if (bullet.x < 0 || bullet.x > room.width || 
                    bullet.y < 0 || bullet.y > room.height ||
                    bullet.life <= 0) {
                    bullets.splice(i, 1);
                    continue;
                }
                
                // 检测子弹与敌人的碰撞
                for (let j = enemies.length - 1; j >= 0; j--) {
                    const enemy = enemies[j];
                    const dist = Math.sqrt((bullet.x - enemy.x) ** 2 + (bullet.y - enemy.y) ** 2);
                    
                    if (dist < bullet.radius + enemy.radius) {
                        // 击中敌人
                        enemy.health -= bullet.damage;
                        
                        // 移除子弹
                        bullets.splice(i, 1);
                        
                        // 如果敌人死亡
                        if (enemy.health <= 0) {
                            // 有几率掉落金币
                            if (Math.random() > 0.7) {
                                items.push({
                                    x: enemy.x,
                                    y: enemy.y,
                                    type: 'coin',
                                    value: 1
                                });
                            }
                            
                            enemies.splice(j, 1);
                            enemiesRemaining--;
                            enemiesDefeated++;
                            updateUI();
                        }
                        
                        break;
                    }
                }
            }
            
            // 更新敌人
            enemies.forEach(enemy => {
                // 敌人AI
                const angleToPlayer = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                
                // 根据敌人类型采取不同行为
                if (enemy.type === 0) {
                    // 类型0：追逐玩家
                    enemy.x += Math.cos(angleToPlayer) * enemy.speed;
                    enemy.y += Math.sin(angleToPlayer) * enemy.speed;
                } else if (enemy.type === 1) {
                    // 类型1：随机移动
                    if (Math.random() < 0.02) {
                        enemy.targetX = Math.random() * room.width;
                        enemy.targetY = Math.random() * room.height;
                    }
                    
                    const angleToTarget = Math.atan2(enemy.targetY - enemy.y, enemy.targetX - enemy.x);
                    enemy.x += Math.cos(angleToTarget) * enemy.speed * 0.7;
                    enemy.y += Math.sin(angleToTarget) * enemy.speed * 0.7;
                } else if (enemy.type === 2) {
                    // 类型2：远程攻击
                    if (enemy.shootCooldown <= 0) {
                        const enemyAngle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                        bullets.push({
                            x: enemy.x,
                            y: enemy.y,
                            dx: Math.cos(enemyAngle) * 5,
                            dy: Math.sin(enemyAngle) * 5,
                            radius: 5,
                            damage: 1,
                            color: '#ff6666',
                            life: 120
                        });
                        enemy.shootCooldown = 60;
                    } else {
                        enemy.shootCooldown--;
                    }
                } else {
                    // 类型3：快速移动
                    enemy.x += Math.cos(angleToPlayer) * enemy.speed * 1.5;
                    enemy.y += Math.sin(angleToPlayer) * enemy.speed * 1.5;
                }
                
                // 敌人边界检测
                if (enemy.x - enemy.radius < 5) enemy.x = enemy.radius + 5;
                if (enemy.x + enemy.radius > room.width - 5) enemy.x = room.width - enemy.radius - 5;
                if (enemy.y - enemy.radius < 5) enemy.y = enemy.radius + 5;
                if (enemy.y + enemy.radius > room.height - 5) enemy.y = room.height - enemy.radius - 5;
                
                // 检测敌人与玩家的碰撞
                if (player.invincible <= 0) {
                    const distToPlayer = Math.sqrt((enemy.x - player.x) ** 2 + (enemy.y - player.y) ** 2);
                    if (distToPlayer < enemy.radius + player.radius) {
                        playerHealth--;
                        player.invincible = 30; // 无敌时间
                        updateUI();
                        
                        // 检查游戏结束
                        if (playerHealth <= 0) {
                            gameOver(false);
                        }
                    }
                }
            });
            
            // 检测玩家与物品的碰撞
            for (let i = items.length - 1; i >= 0; i--) {
                const item = items[i];
                const distToPlayer = Math.sqrt((item.x - player.x) ** 2 + (item.y - player.y) ** 2);
                
                if (distToPlayer < 20 + player.radius) {
                    if (item.type === 'health') {
                        playerHealth = Math.min(playerHealth + item.value, 10);
                    } else if (item.type === 'coin') {
                        playerCoins += item.value;
                    }
                    
                    items.splice(i, 1);
                    updateUI();
                }
            }
            
            // 检测玩家与门的碰撞
            room.doors.forEach(door => {
                if (player.x + player.radius > door.x && 
                    player.x - player.radius < door.x + door.width &&
                    player.y + player.radius > door.y && 
                    player.y - player.radius < door.y + door.height) {
                    
                    // 如果所有敌人都被击败，进入下一关
                    if (enemiesRemaining <= 0) {
                        if (currentRoom < totalRooms) {
                            currentRoom++;
                            player.x = 50;
                            player.y = room.height / 2;
                            generateRoom(currentRoom);
                        } else {
                            // 通关游戏
                            gameOver(true);
                        }
                    }
                }
            });
            
            // 检测敌人子弹与玩家的碰撞
            bullets.forEach(bullet => {
                if (bullet.color === '#ff6666') { // 敌人子弹
                    const distToPlayer = Math.sqrt((bullet.x - player.x) ** 2 + (bullet.y - player.y) ** 2);
                    if (distToPlayer < bullet.radius + player.radius && player.invincible <= 0) {
                        playerHealth--;
                        player.invincible = 30;
                        updateUI();
                        
                        // 检查游戏结束
                        if (playerHealth <= 0) {
                            gameOver(false);
                        }
                    }
                }
            });
        }
        
        // 更新UI
        function updateUI() {
            document.getElementById('healthValue').textContent = playerHealth;
            document.getElementById('coinsValue').textContent = playerCoins;
            document.getElementById('weaponValue').textContent = player.weapons[player.weapon].name;
            document.getElementById('ammoValue').textContent = player.weapons[player.weapon].ammo === Infinity ? '∞' : player.weapons[player.weapon].ammo;
            document.getElementById('enemyCount').textContent = enemiesRemaining;
        }
        
        // 游戏结束
        function gameOver(success) {
            gameState = 'gameOver';
            
            document.getElementById('gameResult').textContent = 
                success ? '恭喜你通关了!' : '你被击败了!';
            
            document.getElementById('finalRooms').textContent = currentRoom - (success ? 0 : 1);
            document.getElementById('finalEnemies').textContent = enemiesDefeated;
            document.getElementById('finalCoins').textContent = playerCoins;
            
            document.getElementById('gameOver').style.display = 'flex';
        }
        
        // 游戏主循环
        function gameLoop() {
            if (gameState === 'playing') {
                updateGame();
                drawGame();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // 事件监听
        window.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            
            // 切换武器
            if (e.key === 'q') {
                player.weapon = (player.weapon + 1) % player.weapons.length;
                updateUI();
            }
            
            // 使用技能
            if (e.key === ' ' && player.skillCooldown <= 0) {
                player.skillActive = true;
                player.skillDuration = 60; // 持续2秒
                player.skillCooldown = 300; // 冷却5秒
            }
            
            // 拾取物品
            if (e.key === 'e') {
                // 在updateGame中已经处理了碰撞拾取
            }
        });
        
        window.addEventListener('keyup', (e) => {
            keys[e.key.toLowerCase()] = false;
        });
        
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            mouse.x = e.clientX - rect.left;
            mouse.y = e.clientY - rect.top;
        });
        
        canvas.addEventListener('mousedown', (e) => {
            if (e.button === 0) {
                mouse.clicked = true;
            }
        });
        
        canvas.addEventListener('mouseup', (e) => {
            if (e.button === 0) {
                mouse.clicked = false;
            }
        });
        
        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            if (e.deltaY > 0) {
                player.weapon = (player.weapon + 1) % player.weapons.length;
            } else {
                player.weapon = (player.weapon - 1 + player.weapons.length) % player.weapons.length;
            }
            updateUI();
        });
        
        // 开始游戏按钮
        document.getElementById('startButton').addEventListener('click', () => {
            document.getElementById('gameStart').style.display = 'none';
            gameState = 'playing';
            initGame();
        });
        
        // 重新开始按钮
        document.getElementById('restartButton').addEventListener('click', () => {
            document.getElementById('gameOver').style.display = 'none';
            gameState = 'playing';
            initGame();
        });
        
        // 启动游戏循环
        gameLoop();
        
        // 初始绘制
        drawGame();
    </script>
</body>
</html>